name: Container Tests

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["topic/#17"]
jobs:

  pre-test:
    runs-on: ubuntu-latest
    env:
      ARTIFACT: artifact
      YOUR_PAT: ${{ secrets.ANCIENT_BLOG_PAT}}
      YOUR_OWNER: ancient-blog
      YOUR_REPO: hugo.github.io
      YOUR_ARTIFACT_ID: voicevox-data
      VOICEVOX_PATH: content/voicevox
    steps:
      - name: To get artifacts using the GitHub API
        run: |
          curl --header "Authorization: Bearer ${YOUR_PAT}" \
            --header "Accept: application/vnd.github.v3+json" \
            --output artifacts.zip \
            "https://api.github.com/repos/${YOUR_OWNER}/${YOUR_REPO}/actions/artifacts/${YOUR_ARTIFACT_ID}/zip"
        continue-on-error: true  # 初回で成果物がない場合エラーを許可します
      - name: Unzip Artifact
        run: |
          if [ -f artifacts.zip ]; then
            unzip artifacts.zip -d ${ARTIFACT}
          else
            echo "artifacts.zip not found, skipping unzip."
          fi
      - name: Display structure of downloaded files
        run: ls -l
        working-directory: ${{ github.workspace }}/artifact/

  call-voicevosx-workflow:
    needs: pre-test
    uses: ./.github/workflows/voicevosx.yml

  test:
    runs-on: ubuntu-latest
    needs: call-voicevosx-workflow
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          path: ${{ github.workspace }}/content/voicevox/
          name: voicevox-data 
      - name: Display structure of downloaded files
        run: ls -l
        working-directory: ${{ github.workspace }}/content/voicevox/
    
